{% extends 'base.html' %}

{% block links %}
{% load staticfiles %}
<link href="{% static 'meetingroom.css' %}" rel="stylesheet">

{% endblock %}


{% block content %}
{% if user.is_authenticated %}
<div class='container'>
    <div class='container-fluid chat-container bg-light shadow border'>
        <div class='row'>
            <div id='chat' class="col-sm-10">
                <ul id='chat-list' class='list-unstyled'>
                        <!-- <li class="message my-3 py-2 px-4 shadow rounded border">
                            <div class="row border border-muted border-top-0 border-right-0 border-left-0 pb-2 mb-2">
                                <div class="user-info col-3 d-flex">
                                    <img class="rounded-circle" src="https://ui-avatars.com/api/?name=Sean+Capper&amp;rounded=true&amp;size=64" style="width: 32px; height: 32px;">
                                    <span class="align-self-center ml-2">Sean</span></div>
                                <div class="offset-7 col-2 chat-time text-right text-muted font-italic font-weight-light pull-right">
                                    7:21 PM
                                </div>
                            </div>
                            <div class="row">
                                <div class="message-body col-12">another file test</div>
                            </div>

                            <div class="row border-top mt-2 text-right">
                                <div class="message-body col-12"><a href="/files/9tzfn6oooe/SeniorProject.docx">SeniorProject.docx</a> <i class="fas fa-paperclip text-primary"></i></div>
                            </div>
                        </li> -->
                </ul>
            </div>
            <div class='col-sm-2 border border-bottom-0 border-top-0 border-right-0'>
                <div class='row border border-top-0 border-left-0 border-right-0 justify-content-center'>
                    Present
                </div>
                <ul id='member-list' class='list-unstyled text-justify py-1 text-center'>
                    
                </ul>
            </div>
        </div> <!-- end chat row -->
        <div class='row  py-2 px-3 bg-primary border border-bottom-0 border-left-0 border-right-0'>
            <div class='col-sm-10'>
                <textarea id='chat-box' class='form-control mx-auto' placeholder="Type a message..."></textarea>
            </div>
            <div class='col-sm-2 d-flex mx-auto'>
                <button id='attachment-btn' class='btn btn-primary'>
                    <i class="fas fa-paperclip fa-2x"></i>
                </button>
                <button id='send-chat' class='btn btn-primary'>
                    <i class="fas fa-arrow-circle-right fa-2x"></i>
                </button>
                <form id='file-form' action='upload-file/' class='sr-only' method='POST' enctype="multipart/form-data" target='upload_target'>
                    {% csrf_token %}
                    <label for="id_user">User</label>
                    <select name="user" required="" id="id_user">
                        <option value="{{user.user_id}}" selected></option>
                    </select>

                    <label for="id_meeting">Meeting</label>
                    <select name="meeting" required="" id="id_meeting">
                        <option value="{{meeting_id}}" selected></option>
                    </select>
                
                    <label for="id_file_source">File source</label>
                    <input type="file" name="file_source" required id="id_file_source">
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    const file_input = $('#id_file_source')
    var fileName = null;
    var meeting_url = {{ meeting_url }};
    var meeting_id = {{ meeting_id }};

    $('#attachment-btn').click(function(e) {
        e.preventDefault();
        file_input.click();
    });

    $('#id_file_source').on('change', function(e) {
        fileName = $('#id_file_source').val();
    });


    $('#send-chat').trigger('click');
    $('#chat-box').keydown(function(e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code == 13) {
            e.preventDefault();
            $('#send-chat').click();
            return true;
        }
    });


    // create a message that will be displayed in the browser
    function create_message(_user_fname, _user_lname, _message, profile_pic, _timestamp, file_attachment, file_name) {
        var chatList = document.querySelector('#chat-list');
        var message = $('<li></li>', {
            class: 'message my-3 p-2 shadow rounded border',
        });
        var row1 = $('<div></div>', {
            class: 'row border border-muted border-top-0 border-right-0 border-left-0 pb-2 mb-2'
        });
        var user_info_div = $('<div></div>', {
            class: 'user-info col-3 d-flex',
        });
        var profile_pic = $("<img />", {
            class: 'rounded-circle',
            width: '32px',
            height: '32px',
            src: 'https://ui-avatars.com/api/?name=' + _user_fname + '+' + _user_lname + '&rounded=true&size=64',
        });
        var profile_name = $("<span>" + _user_fname + "</span>").addClass('align-self-center ml-2');
        var time_stamp = $('<div>' + _timestamp + '</div>').addClass('offset-7 col-2 chat-time text-right text-muted font-italic font-weight-light pull-right');
        
        var row2 = $('<div></div>', {
            class: 'row pb-2',
        });

        var message_body = $('<div>' + _message + '</div>').addClass('message-body col-12');
3 
        user_info_div.append(profile_pic);
        user_info_div.append(profile_name);
        row1.append(user_info_div)
        row1.append(time_stamp);
        row2.append(message_body);
        message.append(row1);
        message.append(row2);


        if(file_attachment != null) {
            var link = $('<div class="row border-top mt-2 text-right">'+
                            '<div class="col-12">'+
                                '<a href="/files/'+file_attachment+'">'+file_name+'</a> '+ 
                                '<i class="fas fa-paperclip text-primary"></i>'+
                            '</div>'+
                            '</div>', {}
            );
            message.append(link);
        }

        $('#chat-list').append(message);
    }

    // connect to the same meeting as everyone else
    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/m/' + meeting_url + '/');
    
    chatSocket.onopen = function(e) {
        var data = {
            'meeting_id': meeting_id,
        }
        $.ajax({
            url: 'load-history',
            type: 'GET',
            data: data,
            success: function(json) {
                json.forEach(message => {
                    console.log(message);
                    create_message(message['user_firstname'], message['user_lastname'], message['message'], '', message['timestamp'], message['file_source'], message['file_name'])
                })
            }
        });
    };

    // happens whenever the socket recieves a message
    chatSocket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        if(data['type'] == 'chat_message') {
            var user_firstname = data['user_firstname'];
            var user_lastname = data['user_lastname'];
            var message = data['message'];
            var timestamp = data['timestamp'];
            var file_source = data['file_source'];
            
            // create a message object and add it to chat list
            create_message(user_firstname, user_lastname, message, '', timestamp, file_source);
        }
        // add the new list of members to the memberlist element
        else if(data['type'] == 'refresh_members_list') {
            var members = data['members'];
            $('#member-list').empty();
            members.forEach(member_name => {
                $('#member-list').append('<li>'+member_name+'</li>');
            });
        }
    };

    // what happens when the socket connection closes
    chatSocket.onclose = function (e) {
        console.error("WebSocket has closed unexpectedly!");
    };

    document.querySelector('#send-chat').focus();
    document.querySelector('#send-chat').onkeyup = function (e) {
        if (e.keyCode == 13) {
            document.querySelector('#send-chat').click();
        }
    }
    
    document.querySelector('#send-chat').onclick = function (e) {
        var messageInputDom = document.querySelector('#chat-box');
        var message = messageInputDom.value;
        var uploaded_file;
        // send the attachment if it exists
        if(fileName) {
            // an attachment exists, so send it to the server with the message
            var form = $('#file-form');
            var url = $('#file-form').attr('action');
            var data = new FormData(form[0]);
            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                cache: false,
                processData: false,
                contentType: false,
                success: function(response) {}
            }).done(function(response){
                var json_message = JSON.stringify({
                    'type': 'chat_message',
                    'meetingID': "{{ meeting_id }}",
                    'userID': "{{ user.user_id }}",
                    'message': message,
                    'timestamp': (new Date().toLocaleTimeString('en-US', {
                        hour12: true,
                        hour: "numeric",
                        minute: "numeric"
                    })).toString(),
                    'file_source': response['file_source'],
                });
                chatSocket.send(json_message);
            });
        } else {
            var json_message = JSON.stringify({
                'type': 'chat_message',
                'meetingID': "{{ meeting_id }}",
                'userID': "{{ user.user_id }}",
                'message': message,
                'timestamp': (new Date().toLocaleTimeString('en-US', {
                    hour12: true,
                    hour: "numeric",
                    minute: "numeric"
                })).toString(),
                'file_source': null,
            });
            chatSocket.send(json_message);
        }
        messageInputDom.value = '';
        file_input.val = '';
    };
    
</script>
</div>

{% endblock %}